<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMDb Stealth Dashboard (8+ Rating)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-dsv@3"></script>
</head>
<body>

    <h1>IMDb DASHBOARD(8+ Rating)</h1>
    <div class="subtitle">Cinema Analytics by Szekely Laszlo-Tamas</div>

    <div class="bento-grid">
        
        <section class="area-trend">
            <h2>Rating History</h2>
            <p class="insight">
                Historical analysis of IMDb scores. 
                <span style="color:var(--accent-red)">Consistent 9.0+ ratings</span> became rarer after the year 2000.
            </p>
            <div id="vis-trend" class="viz-container"></div>
        </section>

        <section class="area-stats" style="justify-content: center; gap: 20px;">
            <div class="stat-block">
                <span id="stat-total-movies" class="stat-number">...</span>
                <span class="stat-label">Movies Analyzed</span>
            </div>
            <div style="width: 100%; height: 1px; background: #333; margin: 10px 0;"></div>
            <div class="stat-block">
                <span id="stat-avg-rating" class="stat-number">...</span>
                <span class="stat-label">Global Avg Rating</span>
            </div>
        </section>

        <section class="area-decade">
            <h2>Decade Dominance</h2>
            <p class="insight">Number of top-rated movies released per decade.</p>
            <div id="vis-decade" class="viz-container"></div>
        </section>

        <section class="area-box">
            <h2>Rating Distributions</h2>
            <p class="insight">Zoomed view (8.0 - 10.0) by Certification.</p>
            <div id="vis-box" class="viz-container"></div>
        </section>

        <section class="area-heat">
            <h2>Density Matrix</h2>
            <p class="insight">Concentration of highly rated movies vs. Runtime.</p>
            <div id="vis-heat" class="viz-container"></div>
        </section>

        <section class="area-toplist">
            <h2>Top Performers</h2>
            <p class="insight">Highest rated movies in dataset.</p>
            <ul id="top-performers-list" class="top-list"></ul>
        </section>

        <section class="area-new1">
            <h2>Popularity vs. Quality</h2>
            <p class="insight">Do more votes equal higher ratings? (Size = Vote Count)</p>
            <div id="vis-scatter" class="viz-container"></div>
        </section>

        <section class="area-new2">
            <h2>Most Voted</h2>
            <div id="vis-topvotes" class="viz-container"></div>
        </section>

    </div>

    <script>
        async function loadAndProcessData() {
            try {
                const response = await fetch('imdb_data.csv');
                const text = await response.text();
                
                // Parse CSV
                const data = d3.csvParse(text, (d) => {
                    // 1. CLEAN VOTES
                    let votes = d.Votes || "0";
                    votes = votes.replace(/[()]/g, ''); 
                    let multiplier = 1;
                    if (votes.includes('M')) { multiplier = 1000000; votes = votes.replace('M', ''); }
                    else if (votes.includes('K')) { multiplier = 1000; votes = votes.replace('K', ''); }
                    
                    // 2. CLEAN DURATION
                    let duration = 0;
                    if (d.Duration) {
                        const hMatch = d.Duration.match(/(\d+)h/);
                        const mMatch = d.Duration.match(/(\d+)m/);
                        if (hMatch) duration += parseInt(hMatch[1]) * 60;
                        if (mMatch) duration += parseInt(mMatch[1]);
                    }

                    // 3. CLEAN YEAR & DECADE
                    // We create a Date String ("1994-01-01") for the Chart, and an Integer (1994) for Math.
                    const yearInt = parseInt(d.Year);
                    const yearDate = !isNaN(yearInt) ? `${yearInt}-01-01` : null;
                    const decade = !isNaN(yearInt) ? Math.floor(yearInt / 10) * 10 : null;

                    return {
                        ...d,
                        YearInt: yearInt,
                        YearDate: yearDate, // Use this for Temporal Axes
                        Decade: decade,     // Use this for Decade Chart
                        Rating: +d.Rating,
                        VotesRaw: parseFloat(votes) * multiplier,
                        DurationMins: duration
                    };
                });

                // Filter bad rows
                const cleanData = data.filter(d => d.YearDate && !isNaN(d.Rating));

                // --- UPDATE STATS ---
                document.getElementById('stat-total-movies').innerText = cleanData.length;
                const avg = cleanData.reduce((acc, c) => acc + c.Rating, 0) / cleanData.length;
                document.getElementById('stat-avg-rating').innerText = avg.toFixed(1);

                // Top List
                const topMovies = [...cleanData].sort((a, b) => b.Rating - a.Rating).slice(0, 3);
                document.getElementById('top-performers-list').innerHTML = topMovies.map(m => `
                    <li>
                        <span class="movie-title">${m.Title}</span>
                        <span class="movie-score">${m.Rating.toFixed(1)}</span>
                    </li>
                `).join('');

                renderCharts(cleanData);

            } catch (err) {
                console.error("Error loading data:", err);
                document.querySelector('.bento-grid').innerHTML = `<h2 style="color:red; text-align:center; grid-column: 1/-1;">Error loading data. Check console.</h2>`;
            }
        }

        function renderCharts(cleanData) {
            const darkConfig = {
                "background": "transparent",
                "view": {"stroke": "transparent"},
                "font": "Inter",
                "axis": {
                    "domainColor": "#333", "gridColor": "#222", "tickColor": "#333",
                    "labelColor": "#666", "titleColor": "#888", "titleFontWeight": "normal"
                },
                "legend": {"labelColor": "#888", "titleColor": "#fff"},
                "title": {"color": "#fff", "fontSize": 14, "anchor": "start"}
            };

            // 1. TREND LINE (Uses YearDate ISO String)
            vegaEmbed('#vis-trend', {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": cleanData},
                "width": "container", "height": "container",
                "config": darkConfig,
                "mark": { "type": "line", "color": "#D90429", "interpolate": "monotone", "point": {"filled": true, "fill": "#050505", "stroke": "#D90429"} },
                "encoding": {
                    "x": { "field": "YearDate", "type": "temporal", "title": null },
                    "y": { "field": "Rating", "type": "quantitative", "aggregate": "mean", "scale": {"zero": false}, "title": "Avg Rating" },
                    "tooltip": [{"field": "YearDate", "type": "temporal", "format": "%Y", "title": "Year"}, {"field": "Rating", "aggregate": "mean", "format": ".2f"}]
                }
            }, {actions: false});

            // 2. DECADE BAR (Uses Pre-calculated Decade)
            vegaEmbed('#vis-decade', {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": cleanData},
                "width": "container", "height": "container",
                "config": darkConfig,
                "mark": {"type": "bar", "color": "#333", "cornerRadiusEnd": 2},
                "encoding": {
                    "x": { "field": "Decade", "type": "ordinal", "title": "Decade", "axis": {"labelAngle": 0} },
                    "y": { "aggregate": "count", "title": "Movie Count" },
                    "color": { "condition": {"test": "datum.count > 5", "value": "#D90429"}, "value": "#333" },
                    "tooltip": [{"field": "Decade"}, {"aggregate": "count"}]
                }
            }, {actions: false});

            // 3. BOX PLOT
            vegaEmbed('#vis-box', {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": cleanData},
                "width": "container", "height": "container",
                "config": darkConfig,
                "transform": [{"filter": "datum.AgeRating != null"}],
                "mark": {"type": "boxplot", "extent": "min-max", "color": "#D90429", "size": 30},
                "encoding": {
                    "x": {"field": "AgeRating", "type": "nominal", "title": null},
                    "y": { "field": "Rating", "type": "quantitative", "scale": {"domain": [8, 10]}, "title": "Score (8-10)" },
                    "tooltip": [{"field": "AgeRating"}]
                }
            }, {actions: false});

            // 4. HEATMAP
            vegaEmbed('#vis-heat', {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": cleanData},
                "width": "container", "height": "container",
                "config": darkConfig,
                "mark": "rect",
                "encoding": {
                    "x": {"field": "DurationMins", "bin": {"maxbins": 20}, "title": "Runtime (min)"},
                    "y": {"field": "Rating", "bin": {"maxbins": 10}, "title": "Rating"},
                    "color": {"aggregate": "count", "scale": {"scheme": "reds"}, "legend": null},
                    "tooltip": [{"bin": "binned_DurationMins", "field": "DurationMins", "title": "Mins"}, {"aggregate": "count"}]
                }
            }, {actions: false});

            // 5. SCATTER PLOT
            vegaEmbed('#vis-scatter', {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": cleanData},
                "width": "container", "height": "container",
                "config": darkConfig,
                "mark": {"type": "circle", "opacity": 0.6, "color": "#D90429"},
                "encoding": {
                    "x": {"field": "VotesRaw", "type": "quantitative", "scale": {"type": "log"}, "title": "Votes (Log)"},
                    "y": {"field": "Rating", "type": "quantitative", "scale": {"domain": [8, 9.5]}, "title": "Rating"},
                    "size": {"field": "VotesRaw", "type": "quantitative", "legend": null},
                    "tooltip": [{"field": "Title"}, {"field": "Rating"}, {"field": "Votes", "title": "Votes"}]
                }
            }, {actions: false});

            // 6. TOP VOTES BAR
            vegaEmbed('#vis-topvotes', {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": cleanData},
                "width": "container", "height": "container",
                "config": darkConfig,
                "transform": [
                    {"window": [{"op": "rank", "as": "rank"}], "sort": [{"field": "VotesRaw", "order": "descending"}]},
                    {"filter": "datum.rank <= 5"}
                ],
                "mark": {"type": "bar", "color": "#333"},
                "encoding": {
                    "y": {"field": "Title", "type": "nominal", "sort": "-x", "axis": {"labelLimit": 150}},
                    "x": {"field": "VotesRaw", "type": "quantitative", "title": "Total Votes"},
                    "color": {"value": "#D90429"},
                    "tooltip": [{"field": "Title"}, {"field": "Votes", "title": "Count"}]
                }
            }, {actions: false});
        }

        loadAndProcessData();
    </script>
</body>

</html>
